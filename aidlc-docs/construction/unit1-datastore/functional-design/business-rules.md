# Business Rules - Unit 1: DataStore

---

## 1. 데이터 검증 규칙

### 1.1 Store 검증
- `id`: 영숫자만 허용, 3-20자, 시스템 내 고유
- `name`: 빈 문자열 불가, 1-100자

### 1.2 AdminUser 검증
- `username`: 영숫자만 허용, 3-30자, 동일 매장 내 고유
- `password`: 최소 8자 (해싱 전 원본 기준)
- `role`: "admin" 또는 "staff"만 허용
- `login_attempts`: 0-5 범위, 5 도달 시 계정 잠금

### 1.3 Menu 검증
- `name`: 빈 문자열 불가, 1-100자
- `price`: 정수, 0 이상, 1,000,000 이하
- `category`: 빈 문자열 불가, 1-50자
- `description`: 최대 500자 (선택)
- `image_url`: URL 형식이거나 빈 문자열 (선택)
- `sort_order`: 0 이상 정수

### 1.4 Table 검증
- `table_number`: 1 이상 정수, 동일 매장 내 고유
- `password`: 최소 4자 (해싱 전 원본 기준)

### 1.5 TableSession 검증
- `id` 형식: `T{테이블번호 2자리 패딩}-{YYYYMMDDHHmmss}`
  - 예: `T05-20260209143000`
- `expires_at`: `started_at` + 16시간
- 동일 테이블에 `active` 세션은 최대 1개

### 1.6 Order 검증
- `order_number` 형식: `YYYYMMDD-NNNNN` (5자리 순번, 매장별 일일 리셋)
  - 예: `20260209-00001`, `20260209-00002`
- `items`: 최소 1개 항목 필수
- `total_amount`: 모든 items의 subtotal 합계와 일치해야 함
- `status`: OrderStatus enum 값만 허용
- 주문 생성 시 해당 세션이 `active` 상태여야 함

### 1.7 OrderItem 검증
- `menu_id`: 유효한 Menu ID 참조
- `quantity`: 1 이상, 99 이하 정수
- `subtotal`: `price × quantity`와 일치해야 함
- `menu_name`, `price`: 주문 시점의 메뉴 정보 스냅샷 (이후 메뉴 변경에 영향 없음)

---

## 2. 상태 전이 규칙

### 2.1 주문 상태 전이 (OrderStatus)

```
pending → preparing → completed
```

| 현재 상태 | 허용 전이 | 설명 |
|----------|----------|------|
| pending | preparing | 주문 접수 → 준비 시작 |
| pending | completed | 주문 접수 → 즉시 완료 (빠른 메뉴) |
| preparing | completed | 준비 중 → 완료 |
| completed | (없음) | 최종 상태, 변경 불가 |

- 역방향 전이 불가 (completed → preparing 등)
- 삭제는 상태와 무관하게 관리자 권한으로 가능

### 2.2 세션 상태 전이 (SessionStatus)

```
active → ended
```

| 현재 상태 | 허용 전이 | 설명 |
|----------|----------|------|
| active | ended | 세션 종료 (이용 완료) |
| ended | (없음) | 최종 상태, 재활성화 불가 |

- 세션 만료 시간 도달 시 자동으로 `ended` 처리하지 않음 (조회 시 만료 여부 확인)
- 새 세션은 항상 새로 생성

---

## 3. 동시성 제어 규칙

### 3.1 파일 잠금
- 엔티티별 독립적인 asyncio.Lock 사용
- 잠금 단위: 엔티티 타입 + 매장 ID (예: `orders_store001`)
- 읽기/쓰기 모두 잠금 획득 필요 (단순화를 위해 배타적 잠금)

### 3.2 원자적 쓰기
- 쓰기 절차:
  1. 임시 파일에 데이터 쓰기 (`{filename}.tmp`)
  2. 임시 파일을 원본 파일로 이름 변경 (`os.replace`)
- `os.replace`는 원자적 연산으로 데이터 손실 방지
- 임시 파일 쓰기 실패 시 원본 파일 유지

### 3.3 잠금 타임아웃
- 잠금 획득 대기 시간: 최대 5초
- 타임아웃 시 `ConcurrencyError` 발생
- 호출자가 재시도 결정

---

## 4. 주문 번호 생성 규칙

### 4.1 형식
- `YYYYMMDD-NNNNN`
- YYYYMMDD: 주문 생성 날짜
- NNNNN: 매장별 일일 순번 (5자리, 0 패딩)

### 4.2 순번 관리
- 매장별로 일일 순번 카운터 유지
- 날짜가 변경되면 순번 00001로 리셋
- 순번은 orders.json에서 당일 최대 순번 + 1로 계산
- 동시성 제어: 주문 생성 시 파일 잠금 내에서 순번 할당

### 4.3 예시
```
20260209-00001  (2026년 2월 9일 첫 번째 주문)
20260209-00002  (2026년 2월 9일 두 번째 주문)
20260210-00001  (2026년 2월 10일 첫 번째 주문, 리셋)
```

---

## 5. 세션 ID 생성 규칙

### 5.1 형식
- `T{NN}-{YYYYMMDDHHmmss}`
- NN: 테이블 번호 (2자리, 0 패딩)
- YYYYMMDDHHmmss: 세션 시작 타임스탬프

### 5.2 예시
```
T01-20260209090000  (테이블 1, 2026-02-09 09:00:00 시작)
T05-20260209143000  (테이블 5, 2026-02-09 14:30:00 시작)
T12-20260210080000  (테이블 12, 2026-02-10 08:00:00 시작)
```

---

## 6. 데이터 파일 관리 규칙

### 6.1 파일 구조
```
data/
├── stores.json              # 전체 매장 목록
├── {store_id}/
│   ├── users.json           # 관리자 계정
│   ├── menus.json           # 메뉴 데이터
│   ├── tables.json          # 테이블 정보
│   ├── sessions.json        # 세션 데이터
│   ├── orders.json          # 현재 주문
│   └── order_history.json   # 과거 주문 이력
```

### 6.2 파일 초기화
- 매장 디렉토리가 없으면 자동 생성
- 파일이 없으면 빈 배열 `[]`로 초기화
- 파일이 손상된 경우 (JSON 파싱 실패) 빈 배열로 리셋 + 로그 기록

### 6.3 데이터 인코딩
- UTF-8 인코딩
- JSON 들여쓰기 2칸 (가독성)
- 날짜/시간: ISO 8601 형식 (예: `2026-02-09T14:30:00Z`)
