# NFR Requirements - Unit 1: DataStore

---

## 1. 성능 요구사항

### 1.1 파일 I/O 성능
| 항목 | 요구사항 | 비고 |
|------|---------|------|
| 단일 파일 읽기 | 제한 없음 | 전체 파일 읽기, MVP 단순화 |
| 단일 파일 쓰기 | 제한 없음 | 원자적 쓰기 (tmp → replace) |
| 파일 크기 제한 | 없음 | 파일 크기 무관하게 전체 읽기/쓰기 |
| 동시 접근 | asyncio.Lock 기반 직렬화 | 엔티티+매장 단위 잠금 |

### 1.2 잠금 타임아웃
| 항목 | 값 | 비고 |
|------|---|------|
| Lock 획득 대기 | 5초 | 타임아웃 시 ConcurrencyError |
| 재시도 정책 | 호출자 결정 | DataStore는 재시도하지 않음 |

### 1.3 데이터 용량 고려사항
- MVP 단계에서 파일 크기 제한을 두지 않음
- 단일 매장 운영 기준으로 데이터 증가량이 제한적
- 향후 필요 시 파일 분할 또는 DB 마이그레이션 고려

---

## 2. 보안 요구사항

### 2.1 비밀번호 해싱
| 항목 | 값 | 비고 |
|------|---|------|
| 알고리즘 | bcrypt | 업계 표준 |
| Cost Factor | 10 | 기본값, 빠른 해싱 |
| 적용 대상 | AdminUser.password, Table.password | 모든 비밀번호 필드 |

### 2.2 데이터 보호
| 항목 | 요구사항 | 비고 |
|------|---------|------|
| 파일 권한 | OS 기본 파일 권한 | 로컬 개발 환경 |
| 민감 데이터 | password_hash만 저장 | 평문 비밀번호 저장 금지 |
| 임시 파일 | 쓰기 실패 시 삭제 | .tmp 파일 잔류 방지 |

### 2.3 입력 검증
| 항목 | 요구사항 | 비고 |
|------|---------|------|
| 검증 레벨 | Pydantic v2 모델 기반 | 타입 + 제약조건 자동 검증 |
| 문자열 길이 | 엔티티별 최대 길이 적용 | domain-entities.md 참조 |
| 숫자 범위 | 엔티티별 범위 적용 | 가격 0~1,000,000 등 |

---

## 3. 신뢰성 요구사항

### 3.1 데이터 무결성
| 항목 | 요구사항 | 비고 |
|------|---------|------|
| 원자적 쓰기 | tmp 파일 → os.replace | 쓰기 중 장애 시 원본 보존 |
| JSON 파싱 실패 | 빈 배열로 리셋 + 로그 | DataCorruptionError 로깅 |
| 디렉토리 자동 생성 | 매장 디렉토리 없으면 생성 | 초기 실행 시 |

### 3.2 동시성 안전
| 항목 | 요구사항 | 비고 |
|------|---------|------|
| 잠금 단위 | 엔티티 타입 + 매장 ID | 세밀한 잠금 |
| 잠금 방식 | 배타적 잠금 (읽기/쓰기 모두) | 단순화 우선 |
| 데드락 방지 | 단일 Lock만 획득 | 중첩 잠금 없음 |

### 3.3 오류 복구
| 항목 | 요구사항 | 비고 |
|------|---------|------|
| 파일 없음 | 빈 배열 반환 | 자동 초기화 |
| 파일 손상 | 빈 배열로 리셋 | 로그 기록 후 계속 |
| 임시 파일 잔류 | 다음 쓰기 시 덮어쓰기 | 자동 정리 |

---

## 4. 로깅 요구사항

### 4.1 로깅 수준: 표준 (오류 + 쓰기 연산)
| 이벤트 | 로깅 여부 | 로그 레벨 | 비고 |
|--------|:--------:|----------|------|
| 파일 읽기 | ✗ | - | 로깅하지 않음 |
| 파일 쓰기 (성공) | ✓ | INFO | 엔티티, 매장ID, 레코드 수 |
| 파일 쓰기 (실패) | ✓ | ERROR | 엔티티, 매장ID, 오류 메시지 |
| Lock 획득 실패 | ✓ | ERROR | 엔티티, 매장ID, 대기 시간 |
| JSON 파싱 실패 | ✓ | ERROR | 파일 경로, 오류 상세 |
| 디렉토리 생성 | ✓ | INFO | 경로 |
| 시드 데이터 실행 | ✓ | INFO | 생성된 데이터 요약 |

### 4.2 로깅 구현
- Python 표준 `logging` 모듈 사용
- 로거 이름: `datastore`
- 포맷: `%(asctime)s - %(name)s - %(levelname)s - %(message)s`
- 출력: 콘솔 (stdout)

---

## 5. 유지보수성 요구사항

### 5.1 코드 품질
| 항목 | 요구사항 |
|------|---------|
| 타입 힌트 | 모든 함수/메서드에 타입 힌트 적용 |
| Docstring | 공개 메서드에 docstring 작성 |
| 코드 스타일 | PEP 8 준수 |

### 5.2 테스트 커버리지
| 항목 | 요구사항 |
|------|---------|
| 단위 테스트 | 모든 CRUD 메서드 |
| 동시성 테스트 | Lock 동작, 타임아웃 |
| 오류 처리 테스트 | 파일 없음, 파싱 실패, Lock 실패 |
